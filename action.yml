name: 'Vulnetix CLI Action'
description: 'GitHub Action that provides the Vulnetix CLI utility for vulnerability management'
author: 'Vulnetix'
branding:
  icon: 'shield'
  color: 'red'

inputs:
  org-id:
    description: 'Organization ID (UUID) for Vulnetix operations'
    required: true
  version:
    description: 'Version of Vulnetix CLI to use'
    required: false
    default: 'latest'
  project-name:
    description: 'Project name for vulnerability management context'
    required: false
  product-name:
    description: 'Product name for vulnerability management context'
    required: false
  team-name:
    description: 'Team name responsible for the project'
    required: false
  group-name:
    description: 'Group name for organizational hierarchy'
    required: false
  tags:
    description: 'YAML list of tags for categorization (e.g., ["critical", "frontend", "api"])'
    required: false
  tools:
    description: 'YAML array of tool configurations with category, artifact-name, format, and identifier'
    required: false
  task:
    description: 'Task to perform: scan, release, report, triage, upload'
    required: false
    default: 'scan'
  api-key:
    description: 'Direct API Key for Vulnetix authentication (hex digest)'
    required: false
  upload-file:
    description: 'Path to artifact file to upload (used with task: upload)'
    required: false
  upload-format:
    description: 'Override auto-detected artifact format (cyclonedx, spdx, sarif, openvex, csaf_vex)'
    required: false
  production-branch:
    description: 'Production branch name (mandatory for release task unless in PR context)'
    required: false
    default: 'main'
  release-branch:
    description: 'Release branch name (mandatory for release task unless in PR context)'
    required: false
  workflow-run-timeout:
    description: 'Timeout in minutes to wait for sibling job artifacts'
    required: false
    default: '30'

outputs:
  result:
    description: 'Result of the Vulnetix CLI execution'
    value: ${{ steps.vulnetix-run.outputs.result }}
  summary:
    description: 'Summary of vulnerabilities processed'
    value: ${{ steps.vulnetix-run.outputs.summary }}
  upload-uuid:
    description: 'Pipeline UUID of the uploaded artifact (when task is upload)'
    value: ${{ steps.vulnetix-run.outputs.upload-uuid }}

runs:
  using: 'composite'
  steps:
    - name: Validate Release Configuration
      if: inputs.task == 'release'
      shell: bash
      run: |
        echo "ðŸ” Validating release readiness configuration..."
        
        # Check if we're in a PR context
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… Running in PR context - target branch: ${{ github.event.pull_request.base.ref }}"
          echo "âœ… Source branch: ${{ github.event.pull_request.head.ref }}"
          echo "PRODUCTION_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          echo "RELEASE_BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
        else
          # Not in PR, check mandatory branch parameters
          if [ -z "${{ inputs.production-branch }}" ] || [ -z "${{ inputs.release-branch }}" ]; then
            echo "âŒ Error: When not in PR context, both production-branch and release-branch are mandatory for release task"
            echo "Current event: ${{ github.event_name }}"
            echo "Production branch: ${{ inputs.production-branch }}"
            echo "Release branch: ${{ inputs.release-branch }}"
            exit 1
          fi
          echo "PRODUCTION_BRANCH=${{ inputs.production-branch }}" >> $GITHUB_ENV
          echo "RELEASE_BRANCH=${{ inputs.release-branch }}" >> $GITHUB_ENV
        fi
        
        echo "ðŸŽ¯ Release Assessment Configuration:"
        echo "  Production Branch: ${PRODUCTION_BRANCH}"
        echo "  Release Branch: ${RELEASE_BRANCH}"
        echo "  Workflow Run ID: ${{ github.run_id }}"
        echo "  Repository: ${{ github.repository }}"

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: false

    - name: Setup Vulnetix CLI
      shell: bash
      run: |
        echo "Setting up Vulnetix CLI..."

        # Install from source using the action's own repository
        ACTION_DIR="${{ github.action_path }}"
        cd "$ACTION_DIR"

        go build -ldflags "-s -w -X github.com/vulnetix/cli/cmd.version=${{ inputs.version }}" -o "$HOME/bin/vulnetix" .

        echo "$HOME/bin" >> $GITHUB_PATH

        echo "Vulnetix CLI setup complete"

    - name: Authenticate with Vulnetix
      if: inputs.api-key != ''
      shell: bash
      run: |
        vulnetix auth login \
          --method apikey \
          --org-id '${{ inputs.org-id }}' \
          --secret '${{ inputs.api-key }}' \
          --store project

    - name: Verify Vulnetix Authentication
      if: inputs.api-key != ''
      shell: bash
      run: |
        vulnetix auth verify

    - name: Run Vulnetix CLI
      id: vulnetix-run
      shell: bash
      run: |
        echo "Running Vulnetix CLI with org-id: ${{ inputs.org-id }}"

        # Handle upload task separately
        if [ "${{ inputs.task }}" = "upload" ]; then
          UPLOAD_ARGS="upload --file '${{ inputs.upload-file }}' --org-id '${{ inputs.org-id }}' --json"

          if [ -n "${{ inputs.upload-format }}" ]; then
            UPLOAD_ARGS="$UPLOAD_ARGS --format '${{ inputs.upload-format }}'"
          fi

          RESULT=$(eval "vulnetix $UPLOAD_ARGS")
          echo "$RESULT"

          # Extract pipeline ID for output
          PIPELINE_ID=$(echo "$RESULT" | jq -r '.pipelineRecord.uuid // empty' 2>/dev/null || true)
          if [ -n "$PIPELINE_ID" ]; then
            echo "upload-uuid=$PIPELINE_ID" >> $GITHUB_OUTPUT
          fi

          echo "result=success" >> $GITHUB_OUTPUT
          echo "summary=Artifact uploaded successfully" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Build command arguments for other tasks
        ARGS="--org-id ${{ inputs.org-id }}"

        if [ -n "${{ inputs.project-name }}" ]; then
          ARGS="$ARGS --project-name '${{ inputs.project-name }}'"
        fi

        if [ -n "${{ inputs.product-name }}" ]; then
          ARGS="$ARGS --product-name '${{ inputs.product-name }}'"
        fi

        if [ -n "${{ inputs.team-name }}" ]; then
          ARGS="$ARGS --team-name '${{ inputs.team-name }}'"
        fi

        if [ -n "${{ inputs.group-name }}" ]; then
          ARGS="$ARGS --group-name '${{ inputs.group-name }}'"
        fi

        if [ -n "${{ inputs.tags }}" ]; then
          ARGS="$ARGS --tags '${{ inputs.tags }}'"
        fi

        if [ -n "${{ inputs.tools }}" ]; then
          ARGS="$ARGS --tools '${{ inputs.tools }}'"
        fi

        # Add task argument
        ARGS="$ARGS --task '${{ inputs.task }}'"

        # Add release mode arguments if task is release
        if [ "${{ inputs.task }}" = "release" ]; then
          ARGS="$ARGS --production-branch '${PRODUCTION_BRANCH}'"
          ARGS="$ARGS --release-branch '${RELEASE_BRANCH}'"
          ARGS="$ARGS --workflow-timeout '${{ inputs.workflow-run-timeout }}'"
        fi

        # Execute Vulnetix CLI
        eval "vulnetix $ARGS"

        # Set outputs (these would be set by the actual CLI)
        echo "result=success" >> $GITHUB_OUTPUT
        echo "summary=Vulnerability analysis completed" >> $GITHUB_OUTPUT
